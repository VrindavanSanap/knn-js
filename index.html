<html>

<head>
  <title>KNN K Nearest Neighbors in Javascript: demo</title>
  <link type="text/css" href="./demo/jqueryui/css/ui-lightness/jquery-ui-1.8.21.custom.css" rel="Stylesheet" />
  <script type="text/javascript" src="./demo/jqueryui/js/jquery-1.7.2.min.js"></script>
  <script type="text/javascript" src="./demo/jqueryui/js/jquery-ui-1.8.21.custom.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="./demo/npg_include/npgmain.js"></script>
  <script src="./lib/knn.js"></script>
  <script type="text/javascript">


    var grid = tf.zeros([500, 500])
    var density = 4.0;
    var data
    var labels
    var knn = new knnjs.KNN()
    function myinit() {
      data = tf.tensor2d([
        [21, 300],
        [30, 40],
        [153, 376],
        [277, 173],
        [165, 17],
        [133, 211],
        [258, 368],
        [117, 293],
        [432, 144],
        [136, 177]]);
      labels = tf.tensor2d([[1],
      [1],
      [1],
      [1],
      [1],
      [-1],
      [-1],
      [-1],
      [-1],
      [-1]]);

      retrain()
    }
    function retrain() {
      let grid_coords = []
      for (let x = 0.0; x <= WIDTH; x += density) {

        let temp = []
        for (let y = 0.0; y <= WIDTH; y += density) {
          temp.push([x, y])
        }
        grid_coords.push(temp)
      }
      let mat1 = tf.tensor3d(grid_coords)
      console.log(mat1.arraySync())
      var grid = knn.train(data, labels)
    }

    function update() {
    }

    function draw() {
      ctx.clearRect(0, 0, WIDTH, HEIGHT);
      // draw decisions in the grid
      gridd = grid.arraySync()
      for (let x = 0.0; x <= WIDTH; x += density) {
        for (let y = 0.0; y <= HEIGHT; y += density) {
          if (gridd[x / density][y / density] > 0) ctx.fillStyle = `rgb(150,250,150)`;
          else ctx.fillStyle = 'rgb(250,150,150)';
          ctx.fillRect(x - density / 2 - 1, y - density - 1, density + 2, density + 2);
        }
      }


      // draw axes
      ctx.beginPath();
      ctx.strokeStyle = 'rgb(50,50,50)';
      ctx.lineWidth = 1;
      ctx.moveTo(0, HEIGHT / 2);
      ctx.lineTo(WIDTH, HEIGHT / 2);
      ctx.moveTo(WIDTH / 2, 0);
      ctx.lineTo(WIDTH / 2, HEIGHT);
      ctx.stroke();
      ctx.strokeStyle = 'rgb(0,0,0)';

      for (var i = 0; i < data.shape[0]; i++) {
        if (labels.arraySync()[i][0] == 1) ctx.fillStyle = 'rgb(100,200,100)';
        else ctx.fillStyle = 'rgb(200,100,100)';
        ctx.lineWidth = 2;

        drawCircle(data.arraySync()[i][0], data.arraySync()[i][1], 5);
      }



      ctx.fillStyle = 'rgb(0,0,0)';
      // ctx.fillText("Converged in " + 10 + " iterations.", 10, HEIGHT - 30);
      ctx.fillText("K = 1", 10, HEIGHT - 30);
      ctx.fillText("Using Manhatten distance", 10, HEIGHT - 15);


      // var numsupp = 0;
      // for (var i = 0; i < N; i++) { if (2 > 1e-5) numsupp++; }
      // ctx.fillText("Number of support vectors: " + numsupp + " / " + N, 10, HEIGHT - 50);

      // if (3 === 1) ctx.fillText("Using Rbf kernel with sigma = " + rbfKernelSigma.toPrecision(2), 10, HEIGHT - 70);
      // if (0 === 0) ctx.fillText("Using Linear kernel", 10, HEIGHT - 70);

      // ctx.fillText("C = " + "3", 10, HEIGHT - 90);
    }

    function mouseClick(x, y, shiftPressed) {

      // add datapoint at location of click
      data = data.concat(tf.tensor2d([[x, y]]))
      const new_label = shiftPressed ? 1 : -1;
      labels = labels.concat(tf.tensor2d([[new_label]]))
      retrain()
    }

    function keyUp(key) {

      if (key == 82) { // 'r'

        // reset to original data and retrain
        data = data.splice(0, 10);
        labels = labels.splice(0, 10);
        N = 10;
        retrain();
      }
      if (key == 75) { // 'k'

        // toggle between kernels: rbf or linear
        kernelid = 1 - kernelid; // toggle 1 and 0
        retrain();
      }
    }
    function keyDown(key) {
    }


    // UI stuff
    function refreshC(event, ui) {
      const k = ui.value;
      $("#creport").text("K = 1.0(Ability to change comming soon)");
    }

    function refreshSig(event, ui) {
      var logSig = ui.value;
      rbfKernelSigma = Math.pow(10, logSig);
      $("#sigreport").text("RBF Kernel sigma = " + rbfKernelSigma.toPrecision(2));
      if (kernelid == 1) {

      }
    }

    $(function () {
      // for C parameter
      $("#slider1").slider({
        orientation: "horizontal",
        slide: refreshC,
        max: 2.0,
        min: -2.0,
        step: 0.1,
        value: 0.0
      });

      // for rbf kernel sigma
      $("#slider2").slider({
        orientation: "horizontal",
        slide: refreshSig,
        max: 2.0,
        min: -2.0,
        step: 0.1,
        value: 0.0
      });
    });
  </script>

  <style type="text/css">
    canvas {
      border: 1px solid #555;
      margin-top: 10px;
    }

    body {
      text-align: center;
      font-family: Verdana, Helvetica, sans-serif;
      font-size: 12px;
      padding: 0;
      margin: 0;
    }

    h1 {
      font-size: 16px;
    }

    p {
      padding-top: 0;
      padding-bottom: 0;
    }

    #dec {
      width: 100%;
      height: 100px;
      background-color: #F5FAFF;
      border-bottom: 1px solid #E5EAEF;
      margin-bottom: 20px;
    }

    #optsdiv {
      width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
  </style>

</head>

<body onLoad="NPGinit(0.5);">
  <div id="dec">
    <br />
    <h1>K Nearest Neighbors in Javascript</h1>
    <p>
      Heavily inspired by svmjs by Andrej Karpathy <a href="https://github.com/karpathy/svmjs">Github</a> <br />
      <!-- Find me on Twitter <a href="https://twitter.com/karpathy">@karpathy</a> -->
    </p>
  </div>

  <p>
    <b>mouse click</b>: add red data point<br />
    <b>shift + mouse click</b>: add green data point<br />
    <b>'k'</b>: toggle between Linear and Rbf kernel<br />
    <b>'r'</b>: reset<br />
  </p>

  <canvas id="NPGcanvas" width="500" height="500">Browser not supported for Canvas. Get a real
    browser.</canvas><br /><br />

  <div id="optsdiv">
    <div style="width:230px; float: left; margin-left: 10px;">
      <div id="slider1"></div><br /><span id="creport">K = 1.0 (Ability to change comming soon)</span>
    </div>
    <!-- <div style="width:230px; float: right; margin-right: 10px;">
      <div id="slider2"></div><br /><span id="sigreport">RBF Kernel sigma = 1.0</span>
    </div> -->
  </div>


</body>

</html>